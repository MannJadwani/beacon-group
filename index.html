<!doctype html>
<html lang="en">

<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Sargam Detector (Sa Re Ga Ma Pa Dha Ni Sa)</title>
	<style>
		:root {
			--bg: #0b1230;
			--accent: #d6b26e;
			--card: rgba(255, 255, 255, 0.03);
			--text: #ffffff;
			--muted: rgba(255, 255, 255, 0.5);
			--stroke: rgba(255, 255, 255, 0.1);
		}

		* {
			box-sizing: border-box;
			border-radius: 0 !important;
		}

		body {
			margin: 0;
			font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
			color: var(--text);
			background: var(--bg);
			min-height: 100vh;
			display: flex;
			flex-direction: column;
			padding: 0;
		}

		/* Swiss Grid Background */
		.grid-bg {
			position: fixed;
			inset: 0;
			z-index: -1;
			opacity: 0.05;
			background-image: linear-gradient(var(--text) 1px, transparent 1px),
							  linear-gradient(90deg, var(--text) 1px, transparent 1px);
			background-size: 60px 60px;
		}

		.header {
			border-bottom: 1px solid var(--stroke);
			padding: 40px 20px;
			background: rgba(11, 18, 48, 0.8);
			backdrop-filter: blur(10px);
		}

		.container {
			max-width: 1400px;
			margin: 0 auto;
			width: 100%;
			padding: 40px 20px;
		}

		.title-area {
			margin-bottom: 60px;
		}

		.badge {
			display: inline-block;
			border: 1px solid var(--accent);
			color: var(--accent);
			padding: 4px 12px;
			font-size: 10px;
			font-weight: 900;
			text-transform: uppercase;
			letter-spacing: 0.4em;
			margin-bottom: 16px;
		}

		h1 {
			font-size: 48px;
			font-weight: 900;
			text-transform: uppercase;
			letter-spacing: -0.05em;
			margin: 0;
			line-height: 0.9;
		}

		.main-grid {
			display: grid;
			grid-template-columns: 1fr 400px;
			gap: 1px;
			background: var(--stroke);
			border: 1px solid var(--stroke);
		}

		@media (max-width: 1100px) {
			.main-grid {
				grid-template-columns: 1fr;
			}
		}

		.section {
			background: var(--bg);
			padding: 60px;
			display: flex;
			flex-direction: column;
			justify-content: center;
		}

		.note-showcase {
			text-align: center;
			padding: 80px 20px;
		}

		#swara {
			font-size: 240px;
			font-weight: 900;
			line-height: 1;
			color: var(--accent);
			margin-bottom: 40px;
			letter-spacing: -0.1em;
			transition: all 0.1s ease;
		}

		.stats-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 1px;
			background: var(--stroke);
			margin-top: 40px;
			border: 1px solid var(--stroke);
		}

		.stat-box {
			background: var(--bg);
			padding: 24px;
			text-align: center;
		}

		.stat-label {
			font-size: 10px;
			font-weight: 900;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			color: var(--muted);
			margin-bottom: 8px;
		}

		.stat-value {
			font-size: 24px;
			font-weight: 900;
			font-family: monospace;
		}

		.controls {
			background: rgba(255, 255, 255, 0.02);
		}

		.field-group {
			margin-bottom: 32px;
		}

		label {
			display: block;
			font-size: 11px;
			font-weight: 900;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			margin-bottom: 12px;
			color: var(--muted);
		}

		input, select, button {
			width: 100%;
			background: transparent;
			border: 1px solid var(--stroke);
			color: var(--text);
			padding: 18px;
			font-size: 14px;
			font-weight: 700;
			outline: none;
			transition: all 0.2s;
		}

		button {
			cursor: pointer;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			font-size: 12px;
		}

		button.primary {
			background: var(--accent);
			color: var(--bg);
			border-color: var(--accent);
		}

		button.primary:hover {
			background: white;
			border-color: white;
		}

		button.danger {
			border-color: #ff3e00;
			color: #ff3e00;
		}

		button.danger:hover {
			background: #ff3e00;
			color: white;
		}

		button:disabled {
			opacity: 0.2;
			cursor: not-allowed;
		}

		.meter-container {
			margin-top: 60px;
			width: 100%;
		}

		.meter-bar {
			height: 4px;
			background: var(--stroke);
			position: relative;
			overflow: visible;
		}

		.needle {
			position: absolute;
			top: -10px;
			bottom: -10px;
			width: 4px;
			background: var(--accent);
			transition: left 0.1s ease;
			box-shadow: 0 0 20px var(--accent);
		}

		.meter-labels {
			display: flex;
			justify-content: space-between;
			margin-top: 16px;
			font-size: 10px;
			font-weight: 900;
			color: var(--muted);
		}

		.quality-area {
			margin-top: 40px;
			border-top: 1px solid var(--stroke);
			padding-top: 40px;
		}

		.quality-bar {
			height: 2px;
			background: var(--stroke);
			margin-top: 12px;
		}

		.quality-fill {
			height: 100%;
			background: var(--accent);
			width: 0%;
			transition: width 0.1s;
		}

		.swaralist {
			display: flex;
			justify-content: center;
			gap: 20px;
			margin-top: 40px;
			opacity: 0.3;
		}

		.swaralist span {
			font-weight: 900;
			font-size: 12px;
			text-transform: uppercase;
		}

		.status-text {
			margin-top: 40px;
			font-size: 12px;
			color: var(--muted);
			font-weight: 500;
			text-align: center;
			border: 1px solid var(--stroke);
			padding: 20px;
		}

		.btn-row {
			display: grid;
			grid-template-columns: 1fr 1fr;
			gap: 1px;
			background: var(--stroke);
			margin-bottom: 24px;
		}

		.btn-row button {
			border: none;
		}
	</style>
</head>

<body>
	<div class="grid-bg"></div>
	
	<div class="header">
		<div class="container" style="padding: 0;">
			<div class="badge">Sa Re Ga Ma Pa</div>
			<h1>Sargam <span style="color: var(--accent)">Detector</span></h1>
		</div>
	</div>

	<div class="container" style="padding-top: 80px;">
		<div class="main-grid">
			<!-- Visualizer Section -->
			<div class="section note-showcase">
				<div id="swara">—</div>
				
				<div class="meter-container">
					<div class="meter-bar">
						<div id="needle" class="needle" style="left: 50%"></div>
					</div>
					<div class="meter-labels">
						<span>-50 CENTS</span>
						<span>0</span>
						<span>+50 CENTS</span>
					</div>
				</div>

				<div class="stats-grid">
					<div class="stat-box">
						<div class="stat-label">Frequency</div>
						<div id="freq" class="stat-value">—</div>
					</div>
					<div class="stat-box">
						<div class="stat-label">Target</div>
						<div id="targetFreq" class="stat-value">—</div>
					</div>
					<div class="stat-box">
						<div class="stat-label">Cents</div>
						<div id="cents" class="stat-value">—</div>
					</div>
					<div class="stat-box">
						<div class="stat-label">Octave</div>
						<div id="octave" class="stat-value">—</div>
					</div>
				</div>

				<div class="swaralist">
					<span>Sa</span><span>Re</span><span>Ga</span><span>Ma</span><span>Pa</span><span>Dha</span><span>Ni</span>
				</div>

				<div class="status-text" id="status">
					SYSTEM READY. PRESS START TO INITIALIZE ANALYZER.
				</div>
			</div>

			<!-- Control Section -->
			<div class="section controls">
				<div class="btn-row">
					<button id="startBtn" class="primary">Start</button>
					<button id="stopBtn" class="danger" disabled>Stop</button>
				</div>

				<div class="field-group">
					<label>Tonic Frequency (Sa)</label>
					<input id="saFreq" type="number" step="0.01" value="261.63" />
				</div>

				<div class="field-group">
					<label>Analysis Window</label>
					<select id="windowSize">
						<option value="2048">2048 (Fast)</option>
						<option value="4096" selected>4096 (Balanced)</option>
						<option value="8192">8192 (Precision)</option>
					</select>
				</div>

				<div class="btn-row">
					<button id="calibrateBtn" disabled>Calibrate</button>
					<button id="resetBtn">Reset</button>
				</div>

				<div class="quality-area">
					<div style="display: flex; justify-content: space-between; align-items: flex-end;">
						<label style="margin: 0;">Signal Quality</label>
						<span id="qualityText" style="font-size: 10px; font-weight: 900; color: var(--accent);">0%</span>
					</div>
					<div class="quality-bar">
						<div id="qualityBar" class="quality-fill"></div>
					</div>
					<p style="font-size: 11px; color: var(--muted); margin-top: 24px; line-height: 1.6;">
						Keep room quiet and play a single, clear note. Accuracy depends on clean audio input and stable Sa frequency.
					</p>
				</div>
			</div>
		</div>
	</div>

	<script>
		const swaraEl = document.getElementById("swara");
		const freqEl = document.getElementById("freq");
		const targetFreqEl = document.getElementById("targetFreq");
		const centsEl = document.getElementById("cents");
		const octaveEl = document.getElementById("octave");
		const needleEl = document.getElementById("needle");
		const statusEl = document.getElementById("status");

		const startBtn = document.getElementById("startBtn");
		const stopBtn = document.getElementById("stopBtn");
		const calibrateBtn = document.getElementById("calibrateBtn");
		const resetBtn = document.getElementById("resetBtn");

		const saFreqInput = document.getElementById("saFreq");
		const windowSizeSelect = document.getElementById("windowSize");

		const qualityBar = document.getElementById("qualityBar");
		const qualityText = document.getElementById("qualityText");

		const SCALE_DEGREES = [
			{name: "Sa", semitone: 0},
			{name: "Re", semitone: 2},
			{name: "Ga", semitone: 4},
			{name: "Ma", semitone: 5},
			{name: "Pa", semitone: 7},
			{name: "Dha", semitone: 9},
			{name: "Ni", semitone: 11},
		];

		let audioCtx = null;
		let analyser = null;
		let micStream = null;
		let rafId = null;
		let timeData = null;
		let lastStable = {swara: "—", freq: 0, cents: 0, target: 0, octave: 0};
		let smoothing = {freq: null, cents: null};

		function clamp(n, a, b) {
			return Math.max(a, Math.min(b, n));
		}

		function median(arr) {
			const a = arr.slice().sort((x, y) => x - y);
			const m = Math.floor(a.length / 2);
			return a.length % 2 ? a[m] : (a[m - 1] + a[m]) / 2;
		}

		function autoCorrelate(buf, sampleRate) {
			let SIZE = buf.length;

			let rms = 0;
			for (let i = 0; i < SIZE; i++) {
				const v = buf[i];
				rms += v * v;
			}
			rms = Math.sqrt(rms / SIZE);
			if (rms < 0.012) return {freq: -1, clarity: 0, rms};

			let r1 = 0;
			let r2 = SIZE - 1;
			const thres = 0.2;

			for (let i = 0; i < SIZE / 2; i++) {
				if (Math.abs(buf[i]) < thres) {
					r1 = i;
					break;
				}
			}

			for (let i = 1; i < SIZE / 2; i++) {
				if (Math.abs(buf[SIZE - i]) < thres) {
					r2 = SIZE - i;
					break;
				}
			}

			const slice = buf.slice(r1, r2);
			SIZE = slice.length;
			if (SIZE < 32) return {freq: -1, clarity: 0, rms};

			const c = new Float32Array(SIZE);
			for (let i = 0; i < SIZE; i++) {
				let sum = 0;
				for (let j = 0; j < SIZE - i; j++) sum += slice[j] * slice[j + i];
				c[i] = sum;
			}

			let d = 0;
			while (d + 1 < SIZE && c[d] > c[d + 1]) d++;

			let maxval = -1;
			let maxpos = -1;
			for (let i = d; i < SIZE; i++) {
				if (c[i] > maxval) {
					maxval = c[i];
					maxpos = i;
				}
			}

			if (maxpos <= 0) return {freq: -1, clarity: 0, rms};

			let T0 = maxpos;

			const x1 = c[T0 - 1] ?? 0;
			const x2 = c[T0] ?? 0;
			const x3 = c[T0 + 1] ?? 0;

			const a = (x1 + x3 - 2 * x2) / 2;
			const b = (x3 - x1) / 2;
			if (a !== 0) T0 = T0 - b / (2 * a);

			const freq = sampleRate / T0;
			const clarity = clamp(maxval / (c[0] || 1), 0, 1);

			if (!isFinite(freq) || freq < 30 || freq > 2000) return {freq: -1, clarity: 0, rms};
			return {freq, clarity, rms};
		}

		function mapToSargam(freq, saFreq) {
			const relSemis = 12 * Math.log2(freq / saFreq);

			let best = null;
			for (const deg of SCALE_DEGREES) {
				const k = Math.round((relSemis - deg.semitone) / 12);
				const candTotal = deg.semitone + 12 * k;
				const err = relSemis - candTotal;
				const absErr = Math.abs(err);

				if (!best || absErr < best.absErr) {
					best = {
						name: deg.name,
						degree: deg.semitone,
						totalSemis: candTotal,
						cents: err * 100,
						absErr,
					};
				}
			}

			const target = saFreq * Math.pow(2, best.totalSemis / 12);
			const octave = Math.round(best.totalSemis / 12);

			return {
				swara: best.name,
				cents: best.cents,
				targetFreq: target,
				octave,
			};
		}

		function formatSigned(n, digits = 1) {
			const v = Number(n);
			if (!isFinite(v)) return "—";
			const sign = v >= 0 ? "+" : "";
			return sign + v.toFixed(digits);
		}

		function setDisplayEmpty(msg) {
			swaraEl.textContent = "—";
			freqEl.textContent = "—";
			targetFreqEl.textContent = "—";
			centsEl.textContent = "—";
			octaveEl.textContent = "—";
			needleEl.style.left = "50%";
			qualityBar.style.width = "0%";
			qualityText.textContent = "0%";
			if (msg) statusEl.textContent = msg;
		}

		function updateNeedle(cents) {
			const clamped = clamp(cents, -50, 50);
			const pct = ((clamped + 50) / 100) * 100;
			needleEl.style.left = pct + "%";
		}

		function updateQuality(clarity, rms) {
			const q = clamp(clarity, 0, 1);
			qualityBar.style.width = (q * 100).toFixed(0) + "%";
			qualityText.textContent = `${(q * 100).toFixed(0)}%`;
		}

		function smoothValue(prev, next, alpha) {
			if (prev === null || !isFinite(prev)) return next;
			return prev + alpha * (next - prev);
		}

		async function start() {
			try {
				const windowSize = Number(windowSizeSelect.value);
				if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();

				if (micStream) {
					micStream.getTracks().forEach(t => t.stop());
					micStream = null;
				}

				micStream = await navigator.mediaDevices.getUserMedia({
					audio: {
						echoCancellation: false,
						noiseSuppression: false,
						autoGainControl: false
					}
				});

				const source = audioCtx.createMediaStreamSource(micStream);
				analyser = audioCtx.createAnalyser();
				analyser.fftSize = windowSize;
				analyser.smoothingTimeConstant = 0.0;

				timeData = new Float32Array(analyser.fftSize);
				source.connect(analyser);

				startBtn.disabled = true;
				stopBtn.disabled = false;
				calibrateBtn.disabled = false;

				statusEl.textContent = "ANALYZER ACTIVE. SING OR PLAY A NOTE.";
				loop();
			} catch (e) {
				setDisplayEmpty("MIC INITIALIZATION FAILED. ENSURE PERMISSIONS.");
				startBtn.disabled = false;
				stopBtn.disabled = true;
				calibrateBtn.disabled = true;
			}
		}

		function stop() {
			if (rafId) cancelAnimationFrame(rafId);
			rafId = null;

			if (micStream) {
				micStream.getTracks().forEach(t => t.stop());
				micStream = null;
			}

			if (audioCtx) {
				audioCtx.close().catch(() => { });
				audioCtx = null;
			}

			analyser = null;
			timeData = null;
			smoothing = {freq: null, cents: null};

			startBtn.disabled = false;
			stopBtn.disabled = true;
			calibrateBtn.disabled = true;

			setDisplayEmpty("ANALYZER TERMINATED.");
		}

		function loop() {
			rafId = requestAnimationFrame(loop);
			if (!analyser || !audioCtx || !timeData) return;

			analyser.getFloatTimeDomainData(timeData);

			const {freq, clarity, rms} = autoCorrelate(timeData, audioCtx.sampleRate);
			updateQuality(clarity, rms);

			const saFreq = Number(saFreqInput.value) || 261.63;

			if (freq <= 0 || clarity < 0.35) {
				if (lastStable.swara !== "—") {
					swaraEl.textContent = lastStable.swara;
					freqEl.textContent = lastStable.freq ? lastStable.freq.toFixed(2) : "—";
					targetFreqEl.textContent = lastStable.target ? lastStable.target.toFixed(2) : "—";
					centsEl.textContent = isFinite(lastStable.cents) ? formatSigned(lastStable.cents, 1) : "—";
					octaveEl.textContent = String(lastStable.octave);
					updateNeedle(lastStable.cents);
				} else {
					setDisplayEmpty("AWAITING STABLE SIGNAL...");
				}
				return;
			}

			const mapped = mapToSargam(freq, saFreq);

			const freqSm = smoothValue(smoothing.freq, freq, 0.25);
			const centsSm = smoothValue(smoothing.cents, mapped.cents, 0.25);
			smoothing.freq = freqSm;
			smoothing.cents = centsSm;

			const stable = clarity >= 0.55 ? true : false;

			swaraEl.textContent = mapped.swara;
			freqEl.textContent = freqSm.toFixed(2);
			targetFreqEl.textContent = mapped.targetFreq.toFixed(2);
			centsEl.textContent = formatSigned(centsSm, 1);
			octaveEl.textContent = String(mapped.octave);
			updateNeedle(centsSm);

			if (stable) {
				lastStable = {
					swara: mapped.swara,
					freq: freqSm,
					cents: centsSm,
					target: mapped.targetFreq,
					octave: mapped.octave
				};
				statusEl.textContent = "SIGNAL STABLE.";
			} else {
				statusEl.textContent = "WEAK SIGNAL. CHECK ENVIRONMENT.";
			}
		}

		async function calibrateSa() {
			if (!analyser || !audioCtx || !timeData) return;

			calibrateBtn.disabled = true;
			statusEl.textContent = "CALIBRATING TONIC... HOLD SA.";

			const samples = [];
			const startAt = performance.now();
			const durationMs = 2000;

			while (performance.now() - startAt < durationMs) {
				analyser.getFloatTimeDomainData(timeData);
				const out = autoCorrelate(timeData, audioCtx.sampleRate);
				if (out.freq > 0 && out.clarity >= 0.6) samples.push(out.freq);
				await new Promise(r => setTimeout(r, 40));
			}

			if (samples.length < 8) {
				statusEl.textContent = "CALIBRATION FAILED. NEED CLEARER SIGNAL.";
				calibrateBtn.disabled = false;
				return;
			}

			const sa = median(samples);
			saFreqInput.value = sa.toFixed(2);
			smoothing = {freq: null, cents: null};
			lastStable = {swara: "—", freq: 0, cents: 0, target: 0, octave: 0};

			statusEl.textContent = `SA CALIBRATED: ${sa.toFixed(2)} HZ.`;
			calibrateBtn.disabled = false;
		}

		startBtn.addEventListener("click", start);
		stopBtn.addEventListener("click", stop);
		calibrateBtn.addEventListener("click", calibrateSa);
		resetBtn.addEventListener("click", () => {
			saFreqInput.value = "261.63";
			smoothing = {freq: null, cents: null};
			lastStable = {swara: "—", freq: 0, cents: 0, target: 0, octave: 0};
			statusEl.textContent = "SA RESET TO 261.63 HZ.";
		});

		windowSizeSelect.addEventListener("change", () => {
			if (!analyser) return;
			const wasRunning = !!audioCtx;
			if (!wasRunning) return;
			stop();
			setTimeout(() => start(), 80);
		});

		setDisplayEmpty("READY. INITIALIZE SYSTEM.");
	</script>
</body>

</html>
